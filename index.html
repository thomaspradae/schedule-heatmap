<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Schedule Heatmap</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    h1 { margin-bottom: 5px; }
    #scheduleContainer {
      position: relative;
      width: calc(7 * 150px);
      height: calc(38 * 30px); /* 38 half-hour rows */
      border: 1px solid #ccc;
      margin-top: 20px;
    }
    .grid-cell {
      position: absolute;
      border: 1px solid #eee;
      box-sizing: border-box;
    }
    .event-block {
      position: absolute;
      background-color: rgba(0, 128, 255, 0.5);
      border: 1px solid #0070aa;
      color: white;
      padding: 2px;
      cursor: move;
      box-sizing: border-box;
      overflow: hidden;
      font-size: 0.8em;
    }
    #summary {
      margin-top: 20px;
    }
    table {
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 5px 10px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>Interactive Schedule Heatmap</h1>
  <label for="scheduleSelect">Select schedule:</label>
  <select id="scheduleSelect">
      <option value="ana_schedule.csv">Ana's Schedule</option>
      <option value="thomas_schedule.csv">Thomas's Schedule</option>
  </select>
  <button id="loadSchedule">Load Schedule</button>
  
  <div id="summary"></div>
  
  <div id="scheduleContainer"></div>
  
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <!-- Interact.js for drag-and-drop -->
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <script>
    // Config constants
    const cellWidth = 150;       // Width for each day column in px
    const cellHeight = 30;       // Height per half-hour block (each row)
    const baseHour = 4;          // Schedule starts at 04:00
    const numRows = 38;          // 38 half-hour slots from 04:00 to 22:30
    const days = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"];

    // When clicking the button, load the CSV file for the selected schedule
    document.getElementById('loadSchedule').addEventListener('click', () => {
      const file = document.getElementById('scheduleSelect').value;
      loadScheduleCSV(file);
    });

    // Load CSV using PapaParse
    function loadScheduleCSV(filePath) {
      Papa.parse(filePath, {
        download: true,
        complete: function(results) {
          processCSVData(results.data);
        }
      });
    }

    // Process CSV data (assumes first row header; first column = time labels)
    function processCSVData(data) {
      // Check format – if data is an array of arrays:
      if(Array.isArray(data) && Array.isArray(data[0])) {
        let header = data[0]; // e.g. [ "", "Lunes", "Martes", ... ]
        let scheduleMatrix = {};  // scheduleMatrix[day] = array of { time, label }
        for(let i = 1; i < data.length; i++) {
          let row = data[i];
          let time = row[0];
          // Loop over days (from second column onward)
          for(let j = 1; j < header.length; j++) {
            let day = header[j];
            if(!scheduleMatrix[day]) scheduleMatrix[day] = [];
            scheduleMatrix[day].push({ time: time, label: row[j] });
          }
        }
        // Render grid view and the activity summary.
        renderSchedule(scheduleMatrix);
        renderSummary(scheduleMatrix);
      } else {
        console.error("Unexpected CSV format.");
      }
    }
    
    // Convert a HH:MM time string to the row index (0 = 04:00)
    function timeToIndex(timeStr) {
      let parts = timeStr.split(":");
      let hours = parseInt(parts[0]);
      let minutes = parseInt(parts[1]);
      return ((hours - baseHour) * 60 + minutes) / 30;
    }
    
    // Convert an index back to a HH:MM string
    function indexToTime(idx) {
      let totalMinutes = idx * 30 + baseHour * 60;
      let hours = Math.floor(totalMinutes / 60);
      let minutes = totalMinutes % 60;
      return (hours < 10 ? "0" : "") + hours + ":" + (minutes < 10 ? "0" : "") + minutes;
    }
    
    // Render the schedule as an interactive grid with event blocks
    function renderSchedule(scheduleMatrix) {
      const container = document.getElementById("scheduleContainer");
      container.innerHTML = "";  // Clear previous content
      
      // Draw grid background lines
      for(let i = 0; i <= numRows; i++) {
         let hrLine = document.createElement("div");
         hrLine.style.position = "absolute";
         hrLine.style.top = (i * cellHeight) + "px";
         hrLine.style.left = "0px";
         hrLine.style.width = (cellWidth * days.length) + "px";
         hrLine.style.height = "1px";
         hrLine.style.background = "#ddd";
         container.appendChild(hrLine);
      }
      for(let j = 0; j <= days.length; j++){
         let vrLine = document.createElement("div");
         vrLine.style.position = "absolute";
         vrLine.style.left = (j * cellWidth) + "px";
         vrLine.style.top = "0px";
         vrLine.style.height = (numRows * cellHeight) + "px";
         vrLine.style.width = "1px";
         vrLine.style.background = "#ddd";
         container.appendChild(vrLine);
      }
      
      // For each day, group contiguous blocks with the same label (ignoring "Freespace")
      days.forEach((day, dayIndex) => {
        if(!scheduleMatrix[day]) return;
        let blocks = [];
        let currentBlock = null;
        scheduleMatrix[day].forEach((entry, i) => {
          let label = entry.label;
          if(label === "Freespace") {
            if(currentBlock) {
              blocks.push(currentBlock);
              currentBlock = null;
            }
            return;
          }
          if(currentBlock && currentBlock.label === label) {
            // Extend the current block
            currentBlock.endIdx = i;
          } else {
            if(currentBlock) blocks.push(currentBlock);
            currentBlock = { label: label, startIdx: i, endIdx: i };
          }
        });
        if(currentBlock) blocks.push(currentBlock);
        
        // Create a div for each contiguous event block
        blocks.forEach(block => {
          let startIdx = block.startIdx;
          let duration = block.endIdx - block.startIdx + 1;
          let blockDiv = document.createElement("div");
          blockDiv.className = "event-block";
          blockDiv.textContent = block.label + " (" + scheduleMatrix[day][startIdx].time + " - " + indexToTime(timeToIndex(scheduleMatrix[day][startIdx].time) + duration) + ")";
          
          // Position & dimension calculations
          let topPos = startIdx * cellHeight;
          let leftPos = dayIndex * cellWidth;
          let height = duration * cellHeight;
          blockDiv.style.top = topPos + "px";
          blockDiv.style.left = leftPos + "px";
          blockDiv.style.width = (cellWidth - 4) + "px";   // with padding offset
          blockDiv.style.height = (height - 4) + "px";
          
          // Save data attributes for updates on drag
          blockDiv.dataset.day = dayIndex;
          blockDiv.dataset.startIdx = startIdx;
          blockDiv.dataset.duration = duration;
          blockDiv.dataset.label = block.label;
          
          container.appendChild(blockDiv);
        });
      });
      
      // Enable dragging on event blocks.
      enableDragging();
    }
    
    // Enable Interact.js drag functionality
    function enableDragging() {
      interact('.event-block').draggable({
        inertia: true,
        modifiers: [
          interact.modifiers.restrictRect({
            restriction: document.getElementById('scheduleContainer'),
            endOnly: true
          })
        ],
        autoScroll: true,
        onmove: dragMoveListener,
        onend: function (event) {
          let target = event.target;
          let x = parseFloat(target.getAttribute('data-x')) || 0;
          let y = parseFloat(target.getAttribute('data-y')) || 0;
          // Snap to grid
          x = Math.round(x / cellWidth) * cellWidth;
          y = Math.round(y / cellHeight) * cellHeight;
          target.style.transform = 'translate(' + x + 'px, ' + y + 'px)';
          target.setAttribute('data-x', x);
          target.setAttribute('data-y', y);
          let newDay = Math.floor(x / cellWidth);
          let newStartIdx = y / cellHeight;
          target.dataset.day = newDay;
          target.dataset.startIdx = newStartIdx;
          let newTime = indexToTime(newStartIdx);
          let newEnd = indexToTime(newStartIdx + parseInt(target.dataset.duration));
          target.textContent = target.dataset.label + " (" + newTime + " - " + newEnd + ")";
          updateSummary(); // optional: recalc summary if events have moved
        }
      });
      
      function dragMoveListener (event) {
        let target = event.target;
        let x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
        let y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
        target.style.transform = 'translate(' + x + 'px, ' + y + 'px)';
        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);
      }
    }
    
    // Create an activity summary table by counting total hours per activity
    function renderSummary(scheduleMatrix) {
      let counts = {};
      days.forEach(day => {
        if(scheduleMatrix[day]) {
          scheduleMatrix[day].forEach(entry => {
            let label = entry.label;
            if(label !== "Freespace") {
              counts[label] = (counts[label] || 0) + 0.5;  // each row is 0.5 hr
            }
          });
        }
      });
      let summaryDiv = document.getElementById("summary");
      summaryDiv.innerHTML = "<h2>Activity Summary (Hours)</h2>";
      let table = document.createElement("table");
      let headerRow = document.createElement("tr");
      let th1 = document.createElement("th");
      th1.textContent = "Activity";
      let th2 = document.createElement("th");
      th2.textContent = "Hours";
      headerRow.appendChild(th1);
      headerRow.appendChild(th2);
      table.appendChild(headerRow);
      for (let act in counts) {
        let tr = document.createElement("tr");
        let td1 = document.createElement("td");
        td1.textContent = act;
        let td2 = document.createElement("td");
        td2.textContent = counts[act];
        tr.appendChild(td1);
        tr.appendChild(td2);
        table.appendChild(tr);
      }
      summaryDiv.appendChild(table);
    }
    
    // Dummy updateSummary – reloads the CSV to recalc summary (could be optimized)
    function updateSummary() {
      const file = document.getElementById('scheduleSelect').value;
      loadScheduleCSV(file);
    }
  </script>
</body>
</html>
